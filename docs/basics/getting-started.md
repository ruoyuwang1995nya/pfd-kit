# Quickstart 
<style>
  p {
    text-align: justify;
  }
</style>
This section provides the basic steps to get started with PFD-kit.

## Installation
PFD-kit can be installed directly from source using `pip`:
```shell
pip install git+https://github.com/ruoyuwang1995nya/pfd-kit.git
```

## Job Submission
PFD-kit provides a simple CLI interface. For example, submit a fine-tuning workflow with:
```shell
pfd submit finetune.json
```
The `finetune.json` file specifies input parameters for the fine-tuning task. Example files are available in the `examples` directory.

PFD-kit is built on the [dflow](https://github.com/dptech-corp/dflow.git) package and utilizes OPs from the [DPGEN2](https://github.com/deepmodeling/dpgen2.git) project. While local deployment is possible, we recommend using the cloud-based [Bohrium](https://bohrium.dp.tech) platform for the optimal experience.

## Tutorial: Diamond Sillicon
This tutorial demmonstrates the general workflow of PFD-kit with a simple example of crystal Si in diamond structure. The relevant input files can be found at `/examples/silicon`. In this example, we need a efficient deep potential model of Si crytal with high accuracy for large scale atomic simulation, which can be easily generated from pretrained atomic through fine-tuning and distillation using PFD-kit. 

### Generate initial structure
The initial structures for exploration can be generated by perturbing a single frame of diamond Si at `si.poscar`. Ten perturbed frame with 32 atoms each would be generated at `pert_si.extxyz` by the following subcommand:
```bash
pfd perturb -n 10 si.poscar -r 2 2 1
``` 

### Fine-tuning
In this example, we demonstrate the fine-tuning with the DPA-2 pretrained model ([DPA-2.3.1-v3.0.0rc0](https://www.aissquare.com/models/detail?pageType=models&name=DPA-2.3.1-v3.0.0rc0&id=287)) with multiple predicting heads. One of the predicting heads named `Domains_SemiCond` is trained with DFT calculations generated by the `ABACUS` software and covers major types of semiconductor materials. Here, we may fine-tuning our VASP Si model from the `Domains_SemiCond` head. In fine-tuning step, you need to prepare the model file of DPA-2 pretrained model and its associated training script, which can be downloaded from [AIS square](https://www.aissquare.com/models/detail?pageType=models&name=DPA-2.3.1-v3.0.0rc0&id=287). You also need to prepare the pseudopotential file for Si. The directory tree of fine-tune step is as follows:
```bash
examples/
├── c_Si/ 
│   ├── finetune 
│   |   ├── DPA2_medium_28_10M_rc0.pt 
│   │   ├── ft_*.json 
│   │   ├── input_torch_medium.json 
│   │   ├── INCAR.fp 
│   │   ├── POSCAR  
│   │   └── POTCAR
```

#### Job submmision
We needs to modify the one of the input script file starting with `ft_*.json`. The input script is a `JSON` file which contains multiple entries defining various aspects of the PFD workflow. To run this tutorial, we recommend to use the script which submit the VASP remote job through `Slurm` scheduler while doing everything else locally (So you need to install `deepmd-kit` locally). You can also run the workflow entirely on the local machine or run on the Bohrium cloud platform. You should input your log-in credentials submit the VASP jobs. 
```json
"step_configs": {
    "run_fp_config": {
    "template_config": {},
    "executor": {
        "type": "dispatcher",
        "host": "your host",
        "username": "your username",
        "password": "your password",
        "port": 22,
        "private_key_file": null,
        "remote_root": "/remote_root",
        "queue_name":"queue",    
        "machine_dict": {
                    "remote_profile": {
                        "timeout": 600
                        }},
        "resources_dict":{
            "source_list":["path_to_source_file"],
            "module_list": ["remote_module"],
            "custom_flags": ["custom_commands"]
                }},
        "template_slice_config": {
                "group_size": 1,
                "pool_size": 1
            }
        }
}
```
If you choose to run on the `Bohrium` platform or custom `Kubernetes` services, you need first config the host information, and then specify the computing resources for each nodes, which includes image name, machine types, etc. Examples of running `pfd` workflow on `Bohrium` platform is provided. 

After modifying the input script, you can start running `pfd-kit` by the command:
```bash
export DFLOW_MODE='debug'&&export DFLOW_DEBUG_COPY_METHOD='copy'&&pfd submit ft_local_slurm_executor.json
```
> If submitting to `Bohrium`, just use `pfd submit ft_bohr.json`

A workflow ID would be printed out to the console. You can check the workflow progression with the `status` subcommand. 
```bash
$ pfd status si_ft.json WORKFLOW_ID
+-------------+------------+------------+--------------+---------------+------------------+-------------+
|   iteration | type       |   criteria |   force_rmse |   energy_rmse |   selected_frame | converged   |
+=============+============+============+==============+===============+==================+=============+
|         000 | Force_RMSE |       0.06 |    0.0501339 |  0.00093      |               60 | True        |
+-------------+------------+------------+--------------+---------------+------------------+-------------+
```  
The example fine-tuning task would complete in one iteration after collecting a total of 60 frames. The final model can be downloaded to `~/results/model/task.0000/model.ckpt.pt` using the `download` subcommand:
```bash
pfd download ft_local_slurm_executor.json WORKFLOW_ID
```

The fine-tuned model exhibits much better accuracy on the test set, with a high energy prediction error of 0.002 eV/atom and a force prediction error of 0.056 eV/Angstrom, respectively. 

<div style="text-align: center;">
    <img src="../_static/ft_test.png" alt="Fig2" style="zoom: 100%;">
    <p style='font-size:1.0rem; text-align: center; font-weight:none'>Figure 2. Prediction error of the fine-tuned Si model.</p>
</div>

### Distillation
The network structure of fine-tuned model is identical to that of the pre-trained model, which might be inefficient for large-scale atomic simulation. It is possible to transfer the knowledge of the fine-tuned DPA-2 model to a lightweight Deep Potential model with *local descriptor* through the *"knowledge distillation"* process, *i.e.*, train the Deep Potential model with synthetic data generated from the fine-tuned DPA model.  

The distillation workflow is essentially the same as fine-tuning, except that the DFT calculation is replaced by the fine-tuned model and the output model is trained from scratch. You can follow the same procedure to generate initial structures using the `perturb` subcommand. The input script is also very similar except for a few differences. Since there is no need for DFT calculation, you can run the workflow locally. 
```bash
export DFLOW_MODE='debug'&&pfd submit dist_local.json
```
Compared with fine-tuning, the number of frames labeled in each iteration is significantly increased to 1500, with 300 of which as test data set. The distillation would end after one iteration, and the "student" model exhibit similar accuracy to that of the fine-tuned model, but runs much faster:
<div style="text-align: center;">
    <img src="../_static/dist_test.png" alt="Fig3" style="zoom: 100%;">
    <p style='font-size:1.0rem; text-align: center;font-weight:none'>Figure 3. Prediction error of the Si model generated through knowledge distillation.</p>
</div>

<div style="text-align: center;">
    <img src="../_static/efficiency.png" alt="Fig4" style="zoom: 50%;">
    <p style='font-size:1.0rem; text-align: center;font-weight:none'>Figure 4. Comparison between the inference efficiency of the PF and PFD model.</p>
</div>