

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pfd.op.select_confs &mdash; pfd-kit 0.7.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=fe7df9b0"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pfd-kit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics/getting-started.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/guide-on-cli.html">Command guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/guide-on-script.html">Input script guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/argument-for-script.html">Arguments of the input script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/examples.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../development/modules.html">API documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pfd-kit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pfd.op.select_confs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pfd.op.select_confs</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Path</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Optional</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dflow.python</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">OP</span><span class="p">,</span>
    <span class="n">OPIO</span><span class="p">,</span>
    <span class="n">Artifact</span><span class="p">,</span>
    <span class="n">OPIOSign</span><span class="p">,</span>
    <span class="n">Parameter</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pfd.exploration.selector</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ConfSelector</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()],</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="SelectConfs">
<a class="viewcode-back" href="../../../development/pfd.op.html#pfd.op.select_confs.SelectConfs">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SelectConfs</span><span class="p">(</span><span class="n">OP</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select configurations from exploration trajectories for labeling.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SelectConfs.get_input_sign">
<a class="viewcode-back" href="../../../development/pfd.op.html#pfd.op.select_confs.SelectConfs.get_input_sign">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_sign</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OPIOSign</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;conf_selector&quot;</span><span class="p">:</span> <span class="n">ConfSelector</span><span class="p">,</span>
                <span class="s2">&quot;confs&quot;</span><span class="p">:</span> <span class="n">Artifact</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]),</span>
                <span class="s2">&quot;pre_confs&quot;</span><span class="p">:</span> <span class="n">Artifact</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  <span class="c1"># previous selected configurations</span>
                <span class="s2">&quot;optional_parameters&quot;</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">Dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{}),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SelectConfs.get_output_sign">
<a class="viewcode-back" href="../../../development/pfd.op.html#pfd.op.select_confs.SelectConfs.get_output_sign">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_sign</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OPIOSign</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;confs&quot;</span><span class="p">:</span> <span class="n">Artifact</span><span class="p">(</span><span class="n">Path</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SelectConfs.execute">
<a class="viewcode-back" href="../../../development/pfd.op.html#pfd.op.select_confs.SelectConfs.execute">[docs]</a>
    <span class="nd">@OP</span><span class="o">.</span><span class="n">exec_sign_check</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ip</span><span class="p">:</span> <span class="n">OPIO</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OPIO</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Execute the OP.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ip : dict</span>
<span class="sd">            Input dict with components:</span>

<span class="sd">            - `conf_selector`: (`ConfSelector`) Configuration selector.</span>
<span class="sd">            - `type_map`: (`List[str]`) The type map.</span>
<span class="sd">            - `trajs`: (`Artifact(List[Path])`) The trajectories generated in the exploration.</span>
<span class="sd">            - `model_devis`: (`Artifact(List[Path])`) The file storing the model deviation of the trajectory. The order of model deviation storage is consistent with that of the trajectories. The order of frames of one model deviation storage is also consistent with tat of the corresponding trajectory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            Output dict with components:</span>
<span class="sd">            - `report`: (`ExplorationReport`) The report on the exploration.</span>
<span class="sd">            - `conf`: (`Artifact(List[Path])`) The selected configurations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optional_parameters</span> <span class="o">=</span> <span class="n">ip</span><span class="p">[</span><span class="s2">&quot;optional_parameters&quot;</span><span class="p">]</span>
        <span class="n">conf_selector</span> <span class="o">=</span> <span class="n">ip</span><span class="p">[</span><span class="s2">&quot;conf_selector&quot;</span><span class="p">]</span>
        <span class="n">trajs</span> <span class="o">=</span> <span class="n">ip</span><span class="p">[</span><span class="s2">&quot;confs&quot;</span><span class="p">]</span>
        <span class="n">pre_confs</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pre_confs&quot;</span><span class="p">)</span>
        
        <span class="n">confs</span> <span class="o">=</span> <span class="n">conf_selector</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">trajs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Select </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span><span class="si">}</span><span class="s2"> configurations from trajectories.&quot;</span><span class="p">)</span>
        <span class="c1"># entropy based selection</span>
        <span class="n">h_filter</span> <span class="o">=</span> <span class="n">optional_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;h_filter&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">h_filter</span><span class="p">:</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_by_entropy</span><span class="p">(</span><span class="n">confs</span><span class="p">,</span><span class="n">referece</span><span class="o">=</span><span class="n">pre_confs</span><span class="p">,</span> <span class="o">**</span><span class="n">h_filter</span><span class="p">)</span>
        
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;confs&quot;</span><span class="p">)</span>
        <span class="n">out_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_sel</span> <span class="o">=</span> <span class="n">optional_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_sel&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_sel</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_sel</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span><span class="si">}</span><span class="s2"> configurations, but max_sel is </span><span class="si">{</span><span class="n">max_sel</span><span class="si">}</span><span class="s2">. Randomly select </span><span class="si">{</span><span class="n">max_sel</span><span class="si">}</span><span class="s2"> configurations.&quot;</span><span class="p">)</span>
                <span class="n">sel_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">),</span> <span class="n">max_sel</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">confs</span> <span class="o">=</span> <span class="p">[</span><span class="n">confs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sel_indices</span><span class="p">]</span>
        
        <span class="n">write</span><span class="p">(</span><span class="n">out_path</span> <span class="o">/</span> <span class="s2">&quot;confs.extxyz&quot;</span><span class="p">,</span> <span class="n">confs</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;extxyz&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OPIO</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;confs&quot;</span><span class="p">:</span> <span class="n">out_path</span> <span class="o">/</span> <span class="s2">&quot;confs.extxyz&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

        
<div class="viewcode-block" id="SelectConfs.filter_by_entropy">
<a class="viewcode-back" href="../../../development/pfd.op.html#pfd.op.select_confs.SelectConfs.filter_by_entropy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_by_entropy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">confs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Atoms</span><span class="p">],</span>
        <span class="n">reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mf">0.015</span><span class="p">,</span>
        <span class="n">entropy_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span><span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Atoms</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter structures to maximize entropy/diversity.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">quests.descriptor</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_descriptors</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">create_entropy_function</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Factory function to create the appropriate entropy function.&quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">quests.gpu.entropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">entropy</span> <span class="k">as</span> <span class="n">gpu_entropy</span>
        
                <span class="k">def</span><span class="w"> </span><span class="nf">get_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="n">x_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">gpu_entropy</span><span class="p">(</span><span class="n">x_tensor</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using GPU entropy with device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">get_entropy</span>
        
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">quests.entropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">entropy</span> <span class="k">as</span> <span class="n">cpu_entropy</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">get_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">cpu_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using CPU entropy (torch not available)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">get_entropy</span>
            
        <span class="n">num_confs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span>
        <span class="n">get_entropy</span> <span class="o">=</span> <span class="n">create_entropy_function</span><span class="p">()</span>
        <span class="n">filtered_structures</span> <span class="o">=</span> <span class="p">[]</span>
            
        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_ref</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">ref_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">),</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="p">[</span><span class="n">confs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ref_indices</span><span class="p">]</span>
            <span class="n">write</span><span class="p">(</span><span class="s1">&#39;text.extxyz&#39;</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;extxyz&#39;</span><span class="p">)</span>
            <span class="n">other_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)),</span> <span class="n">ref_indices</span><span class="p">)</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="p">[</span><span class="n">confs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other_indices</span><span class="p">]</span>
        <span class="n">current_descriptors</span> <span class="o">=</span> <span class="n">get_descriptors</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">confs</span><span class="p">):</span>
            <span class="n">cand_desc</span> <span class="o">=</span> <span class="n">get_descriptors</span><span class="p">([</span><span class="n">atoms</span><span class="p">],</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
            <span class="n">current_entropy</span> <span class="o">=</span> <span class="n">get_entropy</span><span class="p">(</span>
                <span class="n">current_descriptors</span><span class="p">,</span> 
                <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">tmp_descriptors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">current_descriptors</span><span class="p">,</span> <span class="n">cand_desc</span><span class="p">])</span>
            <span class="n">entropy_tmp</span> <span class="o">=</span> <span class="n">get_entropy</span><span class="p">(</span>
                <span class="n">tmp_descriptors</span><span class="p">,</span> 
                <span class="n">h</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10000</span>
            <span class="p">)</span>
            <span class="n">entropy_delta</span> <span class="o">=</span> <span class="n">entropy_tmp</span> <span class="o">-</span> <span class="n">current_entropy</span>
            <span class="k">if</span> <span class="n">entropy_delta</span> <span class="o">&gt;</span> <span class="n">entropy_threshold</span><span class="p">:</span>
                <span class="n">filtered_structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                <span class="n">current_descriptors</span> <span class="o">=</span> <span class="n">tmp_descriptors</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entropy filtering: selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_structures</span><span class="p">)</span><span class="si">}</span><span class="s2"> structures from </span><span class="si">{</span><span class="n">num_confs</span><span class="si">}</span><span class="s2"> candidates.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entropy: </span><span class="si">{</span><span class="n">entropy_tmp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filtered_structures</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Ruoyu Wang, Hongyu Wu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: main
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../../../v0.0.12/index.html">v0.0.12</a></dd>
      <dd><a href="../../../../v0.0.13/index.html">v0.0.13</a></dd>
      <dd><a href="../../../../v0.0.14/index.html">v0.0.14</a></dd>
      <dd><a href="../../../../v0.1.0/index.html">v0.1.0</a></dd>
      <dd><a href="../../../../v0.1.1/index.html">v0.1.1</a></dd>
      <dd><a href="../../../../v0.1.2/index.html">v0.1.2</a></dd>
      <dd><a href="../../../../v0.1.3/index.html">v0.1.3</a></dd>
      <dd><a href="../../../../v0.1.4/index.html">v0.1.4</a></dd>
      <dd><a href="../../../../v0.2.0/index.html">v0.2.0</a></dd>
      <dd><a href="../../../../v0.3.0/index.html">v0.3.0</a></dd>
      <dd><a href="../../../../v0.3.1/index.html">v0.3.1</a></dd>
      <dd><a href="../../../../v0.3.2/index.html">v0.3.2</a></dd>
      <dd><a href="../../../../v0.3.3/index.html">v0.3.3</a></dd>
      <dd><a href="../../../../v0.3.4/index.html">v0.3.4</a></dd>
      <dd><a href="../../../../v0.3.5/index.html">v0.3.5</a></dd>
      <dd><a href="../../../../v0.4.0/index.html">v0.4.0</a></dd>
      <dd><a href="../../../../v0.4.1/index.html">v0.4.1</a></dd>
      <dd><a href="../../../../v0.4.2/index.html">v0.4.2</a></dd>
      <dd><a href="../../../../v0.4.3/index.html">v0.4.3</a></dd>
      <dd><a href="../../../../v0.5.0/index.html">v0.5.0</a></dd>
      <dd><a href="../../../../v0.5.1/index.html">v0.5.1</a></dd>
      <dd><a href="../../../../v0.5.2/index.html">v0.5.2</a></dd>
      <dd><a href="../../../../v0.5.3/index.html">v0.5.3</a></dd>
      <dd><a href="../../../../v0.6.0/index.html">v0.6.0</a></dd>
      <dd><a href="../../../../v0.6.1/index.html">v0.6.1</a></dd>
      <dd><a href="../../../../v0.6.2/index.html">v0.6.2</a></dd>
      <dd><a href="../../../../v0.6.3/index.html">v0.6.3</a></dd>
      <dd><a href="../../../../v0.6.4/index.html">v0.6.4</a></dd>
      <dd><a href="../../../../v0.6.5/index.html">v0.6.5</a></dd>
      <dd><a href="../../../../v0.7.0/index.html">v0.7.0</a></dd>
      <dd><a href="../../../../v0.8.0/index.html">v0.8.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="select_confs.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>